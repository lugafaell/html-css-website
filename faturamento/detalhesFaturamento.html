<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do Faturamento</title>
    <link rel="icon" href="../imgs/116767489_289311779001162_8843699157529714928_n.jpg" type="image/x-icon">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        #background-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            /* Coloca o contêiner da imagem de fundo atrás do conteúdo principal */
            background-color: #017f2d;
            background-size: 40%;
            background-position: center;
            background-repeat: no-repeat;
        }

        /* Estilos para o contêiner do conteúdo principal */
        .content-container {
            position: relative;
            z-index: 1;
            /* Garante que o conteúdo principal fique acima da imagem de fundo */
            padding: 20px;
            /* Adapte conforme necessário */
        }

        .card {
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            background-color: black;
            color: white;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        .card-title {
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .card-body {
            padding: 1.5rem;
        }

        .card-info {
            background-color: #212529;
            border: 1px solid #ced4da;
        }

        .card-info p {
            margin-bottom: 0.5rem;
        }

        /* Estilos personalizados para o accordion */
        .custom-accordion {
            margin-bottom: 20px;
            /* Adiciona espaçamento na parte inferior */
        }

        .custom-accordion .accordion-button {
            background-color: #343a40;
            /* Cor de fundo do botão */
            color: #ffffff;
            /* Cor do texto do botão */
            border-radius: 5px;
            /* Arredonda os cantos do botão */
        }

        .custom-accordion .accordion-button:focus {
            box-shadow: none;
            /* Remover sombra ao focar */
        }

        .custom-accordion .accordion-button::after {
            color: #ffffff;
            /* Cor do ícone de seta */
        }

        .custom-accordion .accordion-button.collapsed {
            background-color: #343a40;
            /* Cor de fundo do botão quando colapsado */
        }

        .custom-accordion .accordion-collapse {
            background-color: #212529;
            /* Cor de fundo do conteúdo do accordion */
            color: #ffffff;
            /* Cor do texto do conteúdo do accordion */
            border: 1px solid rgba(255, 255, 255, 0.1);
            /* Borda do conteúdo do accordion */
            border-radius: 5px;
            /* Arredonda os cantos do conteúdo do accordion */
        }

        .custom-accordion .accordion-collapse hr {
            border-top-color: rgba(255, 255, 255, 0.1);
            /* Cor da linha horizontal */
        }

        .nota-img {
            max-width: 200px;
            /* Defina o tamanho máximo de largura desejado */
            max-height: 200px;
            /* Defina o tamanho máximo de altura desejado */
            /* Adicione outras propriedades de estilo conforme necessário */
        }
    </style>
</head>

<body>

    <div id="background-container">

    </div>

    <nav class="navbar bg-dark" id="menu" style="position: relative; box-shadow: 0px 0px 20px rgba(0, 0, 0, 0.1);">
        <div class="container-fluid">
            <button class="navbar-toggler bg-success" type="button" data-bs-toggle="offcanvas"
                data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar">
                <span class="navbar-toggler-icon"></span>
            </button>
            <img src="../imgs/Imagem_do_WhatsApp_de_2024-04-30_à_s__12.53.06_24f6df1d-removebg-preview.png" width="30"
                height="30" class="d-inline-block align-top" alt="">

            <div class="offcanvas offcanvas-start bg-dark" tabindex="-1" id="offcanvasNavbar"
                aria-labelledby="offcanvasNavbarLabel">
                <div class="offcanvas-header">
                    <h3 class="text-white" id="userName"></h3>
                    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"
                        aria-label="Close"></button>
                </div>
                <div class="offcanvas-body">
                    <ul class="navbar-nav">
                        <li id="pedidos" class="nav-item">
                            <a class="nav-link text-white" href="../pedidos/pedidos.html">Pedidos</a>
                        </li>
                        <li id="listaPedidos" class="nav-item">
                            <a class="nav-link text-white" href="../pedidos/tabelaPedidos.html">Lista de Pedidos</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-white" href="../faturamento/faturamento.html">Pendentes de
                                Faturamento</a>
                        </li>
                        <li id="pedidosCancelados" class="nav-item">
                            <a class="nav-link text-white" href="../cancelados/tabelaPedidosCancelados.html">Pedidos
                                Cancelados</a>
                        </li>
                        <li id="dashboard" class="nav-item">
                            <a class="nav-link text-white" href="../pedidos/dashboard.html">Dashboard</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link mt-auto text-white" href="#" onclick="logout()">Sair</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <h2 class="text-center mb-4">Detalhes do Faturamento</h2>

        <div class="row">
            <div class="col-12 mb-4">
                <div class="card bg-dark text-light">
                    <div class="card-body" id="faturamentoDetails">
                    </div>
                    <button type="button" class="btn btn-success" id="btnAtualizar"
                        style="display: none;">Atualizar</button>
                </div>
            </div>

            <div class="col-12">
                <div class="card bg-dark text-light">
                    <div class="card-body">
                        <h5>Equipamentos</h5>
                        <div class="accordion custom-accordion" id="equipamentosAccordion">
                        </div>
                        <hr>
                        <h5>Materiais</h5>
                        <div class="accordion custom-accordion" id="materiaisAccordion">
                        </div>
                        <div class="accordion custom-accordion">

                            <h2 class="accordion-header" id="notasAccordionHeading">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#notasAccordionCollapse" aria-expanded="false"
                                    aria-controls="notasAccordionCollapse">
                                    NOTAS
                                </button>
                            </h2>
                            <div id="notasAccordionCollapse" class="accordion-collapse collapse"
                                aria-labelledby="notasAccordionHeading" data-bs-parent="#equipamentosAccordion">
                                <div class="accordion-body">
                                    <!-- Conteúdo do accordion de notas -->
                                    <h6>Comunicado de Uso</h6>
                                    <img id="imgComunicadoUso" class="nota-img" src="" alt="Comunicado de Uso">
                                    <button id="btnUso" class="btn btn-success mt-2"
                                        onclick="downloadImage('imgComunicadoUso')">Baixar Comunicado de Uso</button>
                                    <hr>
                                    <h6>Nota de Remessa</h6>
                                    <img id="imgRemessa" class="nota-img" src="" alt="Nota de Remessa">
                                    <button id="btnRemessa" class="btn btn-success mt-2" onclick="downloadImage('imgRemessa')">Baixar
                                        Nota de Remessa</button>
                                    <hr>
                                    <h6>Nota de Devolução</h6>
                                    <img id="imgDevolucao" class="nota-img" src="" alt="Nota de Devolução">
                                    <button id="btnDevo" class="btn btn-success mt-2" onclick="downloadImage('imgDevolucao')">Baixar
                                        Nota de Devolução</button>
                                    <hr>
                                    <h6>Nota Fiscal</h6>
                                    <img id="imgNotaFiscal" class="nota-img" src="" alt="Nota Fiscal">
                                    <button id="btnFiscal" class="btn btn-success mt-2" onclick="downloadImage('imgNotaFiscal')">Baixar
                                        Nota Fiscal</button>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-success mt-2" id="btnAtualizarEquipamentosMateriais"
                            onclick="logSelecoes()">Atualizar Equipamentos</button>
                    </div>
                </div>
            </div>

        </div>
    </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function downloadImage(imageId) {
            const imgElement = document.getElementById(imageId);
            const imgSrc = imgElement.src;
            const imgName = `${imageId}.png`; // Defina o nome do arquivo aqui

            // Crie um link de download temporário
            const link = document.createElement('a');
            link.href = imgSrc;
            link.download = imgName;

            // Adicione o link ao documento e clique nele para iniciar o download
            document.body.appendChild(link);
            link.click();

            // Limpe o link após o download
            document.body.removeChild(link);
        }

        function logout() {
            // Limpe o token do localStorage
            localStorage.removeItem('token');

            // Limpe o email do usuário do localStorage
            localStorage.removeItem('userEmail');

            // Redirecione para a tela de login
            window.location.href = '../login/tela_login.html';
        }

        async function preencherStatusMotivo() {
            try {
                const response = await fetch('https://api.itmf.app.br/faturamento/receberFaturamento');

                if (!response.ok) {
                    throw new Error('Erro ao obter o Status e Motivo');
                }

                const datas = await response.json();

                if (datas.status) {
                    document.getElementById('status').value = datas.status;
                }
                if (datas.motivo) {
                    document.getElementById('motivo').value = datas.motivo;
                }

            } catch (error) {
                console.error('Erro ao obter o Status e Motivo:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            const imgDevolucao = document.getElementById('imgDevolucao');


            if (!imgDevolucao.src.trim() || !imgDevolucao.src.startsWith("data:image/")) {
                imgDevolucao.style.display = 'none';

                const btnDevo = document.getElementById('btnDevo');
                btnDevo.style.display = 'none';

                // Criar e adicionar o elemento <h3>
                const h7 = document.createElement('h7');
                h7.textContent = "Não possui Nota de Devolução";

                // Inserir o <h3> após o elemento <h6> "Nota de Devolução"
                const notaDeDevolucao = imgDevolucao.previousElementSibling; // Seleciona o <h6> anterior
                notaDeDevolucao.parentNode.insertBefore(h7, notaDeDevolucao.nextSibling);
            }

            const imgComunicadoUso = document.getElementById('imgComunicadoUso');

            if (!imgComunicadoUso.src.trim() || !imgComunicadoUso.src.startsWith("data:image/")) {
                imgComunicadoUso.style.display = 'none';

                const btnUso = document.getElementById('btnUso');
                btnUso.style.display = 'none';

                // Criar e adicionar o elemento <h3>
                const h7 = document.createElement('h7');
                h7.textContent = "Não possui Comunicado de Uso";

                // Inserir o <h3> após o elemento <h6> "Nota de Devolução"
                const notaDeUso = imgComunicadoUso.previousElementSibling; // Seleciona o <h6> anterior
                notaDeUso.parentNode.insertBefore(h7, notaDeUso.nextSibling);
            }

            const imgRemessa = document.getElementById('imgRemessa');

            if (!imgRemessa.src.trim() || !imgRemessa.src.startsWith("data:image/")) {
                imgRemessa.style.display = 'none';

                const btnRemessa = document.getElementById('btnRemessa');
                btnRemessa.style.display = 'none';

                // Criar e adicionar o elemento <h3>
                const h7 = document.createElement('h7');
                h7.textContent = "Não possui Nota de Remessa";

                // Inserir o <h3> após o elemento <h6> "Nota de Devolução"
                const notaDeRemessa = imgRemessa.previousElementSibling; // Seleciona o <h6> anterior
                notaDeRemessa.parentNode.insertBefore(h7, notaDeRemessa.nextSibling);
            }

            const imgNotaFiscal = document.getElementById('imgNotaFiscal');

            if (!imgNotaFiscal.src.trim() || !imgNotaFiscal.src.startsWith("data:image/")) {
                imgNotaFiscal.style.display = 'none';

                const btnFiscal = document.getElementById('btnFiscal');
                btnFiscal.style.display = 'none';

                // Criar e adicionar o elemento <h3>
                const h7 = document.createElement('h7');
                h7.textContent = "Não possui Nota Fiscal";

                // Inserir o <h3> após o elemento <h6> "Nota de Devolução"
                const notaFiscal = imgNotaFiscal.previousElementSibling; // Seleciona o <h6> anterior
                notaFiscal.parentNode.insertBefore(h7, notaFiscal.nextSibling);
            }

            const pedidos = document.getElementById('pedidos');
            const listaPedidos = document.getElementById('listaPedidos');
            const cargo = localStorage.getItem('cargo');
            preencherStatusMotivo();

            if (cargo === "Comercial2") {
                pedidos.style.display = 'none';
            }

            if (cargo === "Comercial") {
                pedidos.style.display = 'none';
                listaPedidos.style.display = 'none';
            }

            if (cargo === "Vendedor" || cargo === "Comercial") {
                const cancelados = document.getElementById('pedidosCancelados');

                cancelados.style.display = 'none';
            }

            if (cargo === "Vendedor" || cargo === "Comercial" || cargo === "Comercial2" || cargo === "Logistica") {
                const dashboard = document.getElementById('dashboard');

                dashboard.style.display = 'none';
            }

            const token = localStorage.getItem('token');
            if (!token) {
                // Se não houver token, redireciona para a página de login
                window.location.href = '../login/tela_login.html';
            }
            // Recupera o email armazenado no localStorage
            const userEmail = localStorage.getItem('userEmail');

            // Atualize o conteúdo do elemento no menu com o valor do email
            if (userEmail !== null) {
                document.getElementById('userName').textContent = `Bem-Vindo, ${userEmail}`;
            } else {
                // Caso o email seja nulo ou indefinido, exiba uma saudação padrão
                document.getElementById('userName').textContent = 'Bem-Vindo, Usuário';
            }
        });

        function getFaturamentoIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        function fillFaturamentoDetails(faturamento) {
            const faturamentoDetailsContainer = document.getElementById('faturamentoDetails');
faturamentoDetailsContainer.innerHTML = '';

const faturamentoFields = [
    'hospital', 'convenio', 'dataProcedimento', 'carimboHorario', 'nomePaciente', 
    'idPaciente', 'vendedor', 'CNPJ', 'formaPagamento', 'valorTotal', 'status', 'motivo'
];

let faturamentoRowHtml = '';

faturamentoFields.forEach(key => {
    const label = key.replace(/([A-Z])/g, ' $1').toUpperCase();
    const value = faturamento[key] || '';

    faturamentoRowHtml += `
        <div class="col-md-4">
            <div class="faturamento-info-item">
                <p class="faturamento-info-label">${label}:</p>
                <p class="faturamento-info-value" id="value-${key}">${value}</p>
                <div class="button-container">
                    ${key !== 'idPaciente' && key !== 'carimboHorario' ? `
                        <button class="acao-btn" data-key="${key}">
                            <i class="fas fa-pencil-alt"></i>
                        </button>
                        <button class="salvar-btn" data-key="${key}" style="display:none;">
                            <i class="fas fa-save"></i></button>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
});

faturamentoDetailsContainer.innerHTML = `
    <div class="row">
        ${faturamentoRowHtml}
    </div>
`;

const cssFaturamentoStyle = `
    .faturamento-info-item {
        background-color: #6a6868;
        border: 1px solid #dee2e6;
        padding: 8px;
        margin-bottom: 10px;
        border-radius: 8px;
        min-height: 120px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    .faturamento-info-label {
        font-weight: bold;
        margin-bottom: 5px;
    }
    .faturamento-info-value {
        margin-bottom: 0;
        flex-grow: 1;
    }
    .button-container {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }
    .acao-btn, .salvar-btn {
        background-color: #6a6868;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
    }
    .acao-btn i, .salvar-btn i {
        margin-right: 5px;
    }
    .acao-btn:hover, .salvar-btn:hover {
        background-color: #0056b3;
    }
`;

const styleFaturamentoElement = document.createElement('style');
styleFaturamentoElement.textContent = cssFaturamentoStyle;
document.head.appendChild(styleFaturamentoElement);

const actionButtons = document.querySelectorAll('.acao-btn');
actionButtons.forEach(button => {
    button.addEventListener('click', (event) => {
        const btn = event.target.closest('.acao-btn');
        if (!btn) return;

        const key = btn.getAttribute('data-key');
        const valueElement = document.getElementById(`value-${key}`);
        const currentValue = valueElement.textContent;

        if (key === 'status' || key === 'motivo') {
            const options = key === 'status' ? `
                <option value="AGUARDANDO FATURAMENTO">AGUARDANDO FATURAMENTO</option>
                <option value="FATURADO">FATURADO</option>
                <option value="FATURADO PARCIAL">FATURADO PARCIAL</option>
                <option value="PENDENCIA ADMINISTRATIVA">PENDENCIA ADMINISTRATIVA</option>
                <option value="PENDENCIA DOCUMENTO">PENDENCIA DOCUMENTO</option>
                <option value="DOAÇÃO SCAFURI">DOAÇÃO SCAFURI</option>
            ` : `
                <option value="COBRANÇA">COBRANÇA</option>
                <option value="ENVIADO PARA JURÍDICO">ENVIADO PARA JURÍDICO</option>
                <option value="PRAZO PORTAL">PRAZO PORTAL</option>
                <option value="AGUARDANDO PRAZO MÊS POSTERIOR">AGUARDANDO PRAZO MÊS POSTERIOR</option>
                <option value="FINALIZADO">FINALIZADO</option>
                <option value="DIVERGÊNCIA FORNECEDOR X CLIENTE">DIVERGÊNCIA FORNECEDOR X CLIENTE</option>
                <option value="GASTO/AUTORIZAÇÃO">GASTO/AUTORIZAÇÃO</option>
                <option value="AUTORIZAÇÃO DIRETORIA ITMF">AUTORIZAÇÃO DIRETORIA ITMF</option>
                <option value="AGUARDANDO REVISÃO DA NFE">AGUARDANDO REVISÃO DA NFE</option>
                <option value="AGUARDANDO ENVIO DO EMAIL">AGUARDANDO ENVIO DO EMAIL</option>
                <option value="AGUARDANDO ENVIO DA NFE">AGUARDANDO ENVIO DA NFE</option>
                <option value="GASTO/COM. DE USO">GASTO/COM. DE USO</option>
                <option value="AGUARDANDO COMERCIAL FATURAR">AGUARDANDO COMERCIAL FATURAR</option>
                <option value="AUTORIZAÇÃO/COM. DE USO">AUTORIZAÇÃO/COM. DE USO</option>
                <option value="GASTO DE SALA(HOSP)">GASTO DE SALA(HOSP)</option>
                <option value="AUTORIZAÇÃO">AUTORIZAÇÃO</option>
                <option value="COMUNICADO DE USO (ITMF)">COMUNICADO DE USO (ITMF)</option>
                <option value="AUTORIZAÇÃO PORTAL">AUTORIZAÇÃO PORTAL</option>
                <option value="AGUARDANDO CONFERÊNCIA DE CIRURGIAS">AGUARDANDO CONFERÊNCIA DE CIRURGIAS</option>
            `;

            valueElement.innerHTML = `<select id="input-${key}" class="form-select">${options}</select>`;
            document.getElementById(`input-${key}`).value = currentValue;
        } else {
            valueElement.innerHTML = `<input type="text" id="input-${key}" value="${currentValue}">`;
        }

        btn.style.display = 'none';
        const saveButton = document.querySelector(`.salvar-btn[data-key="${key}"]`);
        saveButton.style.display = 'inline-block';
    });
});

const saveButtons = document.querySelectorAll('.salvar-btn');
saveButtons.forEach(button => {
    button.addEventListener('click', (event) => {
        const btn = event.target.closest('.salvar-btn');
        if (!btn) return;

        const key = btn.getAttribute('data-key');
        const inputElement = document.getElementById(`input-${key}`);
        const newValue = inputElement.value;

        const valueElement = document.getElementById(`value-${key}`);
        valueElement.innerHTML = newValue;

        btn.style.display = 'none';
        const actionButton = document.querySelector(`.acao-btn[data-key="${key}"]`);
        actionButton.style.display = 'inline-block';

        const updatedData = {
            ...faturamento,
            [key]: newValue
        };

        const faturamentoId = getFaturamentoIdFromUrl();

        fetch(`https://api.itmf.app.br/faturamento/atualizarFaturamento/${faturamentoId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(updatedData)
        })
        .then(response => response.json())
        .then(updatedFaturamento => {
            console.log(`Registro atualizado com sucesso para o campo: ${key}`);
        })
        .catch(error => {
            console.error('Erro ao atualizar registro:', error);
        });
    });
});


            if (faturamento.contador === 1) {
                renderNovosEquipamentos(faturamento.novoEquipamentos);
                renderNovosMateriais(faturamento.novoMateriais);
            } else {
                renderEquipamentos(faturamento.equipamentos);
                renderMateriais(faturamento.materiais);
            }


        }

        function renderNovosEquipamentos(novosEquipamentos) {
            const equipamentosAccordion = document.getElementById('equipamentosAccordion');
            equipamentosAccordion.innerHTML = '';

            novosEquipamentos.forEach(equipamento => {
                const equipamentoContent = `
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading${equipamento.nome.replace(/\s/g, '')}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapse${equipamento.nome.replace(/\s/g, '')}" aria-expanded="false"
                        aria-controls="collapse${equipamento.nome.replace(/\s/g, '')}">
                        ${equipamento.nome}
                    </button>
                </h2>
                <div id="collapse${equipamento.nome.replace(/\s/g, '')}" class="accordion-collapse collapse"
                    aria-labelledby="heading${equipamento.nome.replace(/\s/g, '')}" data-bs-parent="#equipamentosAccordion">
                    <div class="accordion-body">
                        ${renderCheckboxesWithSerialFields(equipamento.nome, equipamento.quantidade)}
                    </div>
                </div>
            </div>
        `;
                equipamentosAccordion.innerHTML += equipamentoContent;
            });
        }

        function renderNovosMateriais(novosMateriais) {
            const materiaisAccordion = document.getElementById('materiaisAccordion');
            materiaisAccordion.innerHTML = '';

            novosMateriais.forEach(material => {
                const materialContent = `
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading${material.nome.replace(/\s/g, '')}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapse${material.nome.replace(/\s/g, '')}" aria-expanded="false"
                        aria-controls="collapse${material.nome.replace(/\s/g, '')}">
                        ${material.nome}
                    </button>
                </h2>
                <div id="collapse${material.nome.replace(/\s/g, '')}" class="accordion-collapse collapse"
                    aria-labelledby="heading${material.nome.replace(/\s/g, '')}" data-bs-parent="#materiaisAccordion">
                    <div class="accordion-body">
                        ${renderCheckboxesWithSerialFields(material.nome, material.quantidade)}
                    </div>
                </div>
            </div>
        `;
                materiaisAccordion.innerHTML += materialContent;
            });
        }

        function renderEquipamentos(equipamentos) {
            const equipamentosAccordion = document.getElementById('equipamentosAccordion');
            equipamentosAccordion.innerHTML = '';

            equipamentos.forEach(equipamento => {
                const equipamentoContent = `
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading${equipamento.nome.replace(/\s/g, '')}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapse${equipamento.nome.replace(/\s/g, '')}" aria-expanded="false"
                        aria-controls="collapse${equipamento.nome.replace(/\s/g, '')}">
                        ${equipamento.nome}
                    </button>
                </h2>
                <div id="collapse${equipamento.nome.replace(/\s/g, '')}" class="accordion-collapse collapse"
                    aria-labelledby="heading${equipamento.nome.replace(/\s/g, '')}" data-bs-parent="#equipamentosAccordion">
                    <div class="accordion-body">
                        ${renderCheckboxesWithSerialFields(equipamento.nome, equipamento.quantidade)}
                    </div>
                </div>
            </div>
        `;
                equipamentosAccordion.innerHTML += equipamentoContent;
            });
        }

        function renderMateriais(materiais) {
            const materiaisAccordion = document.getElementById('materiaisAccordion');
            materiaisAccordion.innerHTML = '';

            materiais.forEach(material => {
                const materialContent = `
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading${material.nome.replace(/\s/g, '')}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#collapse${material.nome.replace(/\s/g, '')}" aria-expanded="false"
                        aria-controls="collapse${material.nome.replace(/\s/g, '')}">
                        ${material.nome}
                    </button>
                </h2>
                <div id="collapse${material.nome.replace(/\s/g, '')}" class="accordion-collapse collapse"
                    aria-labelledby="heading${material.nome.replace(/\s/g, '')}" data-bs-parent="#materiaisAccordion">
                    <div class="accordion-body">
                        ${renderCheckboxesWithSerialFields(material.nome, material.quantidade)}
                    </div>
                </div>
            </div>
        `;
                materiaisAccordion.innerHTML += materialContent;
            });
        }
        function renderCheckboxesWithSerialFields(itemName, quantity) {
            let html = '';
            for (let i = 0; i < quantity; i++) {
                const serieInputId = `${itemName.replace(/\s/g, '')}-serie-${i}`;
                const valueInputId = `${itemName.replace(/\s/g, '')}-value-${i}`;
                html += `
                    <div class="mb-2">
                        <label>
                            <input type="checkbox" class="${itemName.replace(/\s/g, '')}-checkbox" data-nome="${itemName}"
                                data-serie-input="${serieInputId}" data-value-input="${valueInputId}"
                                onchange="toggleSerialInput(this)">
                            ${itemName} ${i + 1}
                        </label>
                        <input type="text" class="form-control mt-1 d-none" placeholder="Número de Série" 
                            id="${serieInputId}">
                        <input type="text" class="form-control mt-1 d-none" placeholder="Valor" 
                            id="${valueInputId}">    
                    </div>
                `;
            }
            return html;
        }

        function toggleSerialInput(checkbox) {
            const serieInputId = checkbox.getAttribute('data-serie-input');
            const serieInput = document.getElementById(serieInputId);

            const valueInputId = checkbox.getAttribute('data-value-input');
            const valueInput = document.getElementById(valueInputId);

            if (checkbox.checked) {
                serieInput.classList.remove('d-none');
                valueInput.classList.remove('d-none');
            } else {
                serieInput.classList.add('d-none');
                serieInput.value = '';

                valueInput.classList.add('d-none');
                valueInput.value = '';
            }
        }

        function fetchFaturamentoDetails() {
            const faturamentoId = getFaturamentoIdFromUrl();

            if (!faturamentoId) {
                console.error('ID do faturamento não encontrado na URL.');
                alert('ID do faturamento não encontrado na URL.');
                return;
            }

            fetch(`https://api.itmf.app.br/faturamento/receberFaturamento/${faturamentoId}`)
                .then(response => response.json())
                .then(faturamento => {
                    fillFaturamentoDetails(faturamento);

                    const contador = faturamento.contador || 0;

                    const imagemBase64 = faturamento.imagemBase64 || null;
                    const imagemRemessa64 = faturamento.imagemRemessa64 || null;
                    const imagemDevolucao64 = faturamento.imagemDevolucao64 || null;
                    const imagemComunicado64 = faturamento.imagemComunicado64 || null;

                    const imagens = {
                        imagemBase64,
                        imagemRemessa64,
                        imagemDevolucao64,
                        imagemComunicado64
                    };

                    const imgComunicadoUso = document.getElementById('imgComunicadoUso');
                    const imgRemessa = document.getElementById('imgRemessa');
                    const imgDevolucao = document.getElementById('imgDevolucao');
                    const imgNotaFiscal = document.getElementById('imgNotaFiscal');

                    imgComunicadoUso.src = imagens.imagemComunicado64;
                    imgRemessa.src = imagens.imagemRemessa64;
                    imgDevolucao.src = imagens.imagemDevolucao64;
                    imgNotaFiscal.src = imagens.imagemBase64;

                })
                .catch(error => {
                    console.error('Erro ao obter detalhes do faturamento:', error);
                });

        }



        function updateFaturamento(faturamentoId) {
            const CNPJ = document.getElementById('CNPJ').value;
            const status = document.getElementById('status').value;
            const motivo = document.getElementById('motivo').value;

            const body = {
                CNPJ,
                status,
                motivo,
            };

            fetch(`https://api.itmf.app.br/faturamento/atualizarFaturamento/atualizar/${faturamentoId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(body),
            })
                .then(response => response.json())
                .then(updatedFaturamento => {
                    console.log(updatedFaturamento);
                    alert('Detalhes do faturamento atualizados com sucesso.');
                    fillFaturamentoDetails(updatedFaturamento);
                })
                .catch(error => {
                    console.error('Erro ao atualizar detalhes do faturamento:', error);
                    alert('Erro ao atualizar detalhes do faturamento. Tente novamente.');
                });
        }

        let contador = 0;

        function calcularSomaValoresSelecionados(equipamentosSelecionados, materiaisSelecionados) {
            let somaEquipamentos = 0;
            let somaMateriais = 0;

            equipamentosSelecionados.forEach(equipamento => {
                const valorEquipamento = equipamento.valor;
                if (!isNaN(valorEquipamento)) {
                    somaEquipamentos += valorEquipamento;
                }
            });

            materiaisSelecionados.forEach(material => {
                const valorMaterial = material.valor;
                if (!isNaN(valorMaterial)) {
                    somaMateriais += valorMaterial;
                }
            });

            const somaTotal = somaEquipamentos + somaMateriais;

            console.log("Soma Total dos Valores Selecionados:", somaTotal.toFixed(2));

            return somaTotal;
        }

        const btnAtualizarEquipamentosMateriais = document.getElementById('btnAtualizarEquipamentosMateriais');
        btnAtualizarEquipamentosMateriais.removeEventListener('click', onClickAtualizarEquipamentos);

        btnAtualizarEquipamentosMateriais.addEventListener('click', onClickAtualizarEquipamentos);

        function onClickAtualizarEquipamentos() {

            const {
                somaTotal,
                equipamentosSelecionados,
                materiaisSelecionados,
                contador
            } = logSelecoes();

            const faturamentoId = getFaturamentoIdFromUrl();
            atualizarDadosFaturamento(faturamentoId, somaTotal, equipamentosSelecionados, materiaisSelecionados, contador);

            location.reload();
        }

        function logSelecoes() {
            const equipamentosSelecionados = [];
            const materiaisSelecionados = [];

            const parseDecimal = (str) => {

                const cleanedStr = typeof str === 'string' ? str.replace(',', '.') : str;
                return parseFloat(cleanedStr);
            };

            const equipamentoItems = document.querySelectorAll('#equipamentosAccordion input[type="checkbox"]');
            equipamentoItems.forEach(item => {
                if (item.checked) {
                    const nomeEquipamento = item.getAttribute('data-nome');
                    const serieInputId = item.getAttribute('data-serie-input');
                    const numeroSerieInput = document.getElementById(serieInputId);
                    const numeroSerie = numeroSerieInput.value.trim();
                    const valueInputId = item.getAttribute('data-value-input');
                    const numeroValueInput = document.getElementById(valueInputId);
                    const numeroValue = parseDecimal(numeroValueInput.value.trim());

                    equipamentosSelecionados.push({
                        nome: nomeEquipamento + " - Nº de Série: " + numeroSerie + " - Valor: " + numeroValue,
                        numeroSerie: numeroSerie,
                        valor: numeroValue
                    });
                }
            });

            const materialItems = document.querySelectorAll('#materiaisAccordion input[type="checkbox"]');
            materialItems.forEach(item => {
                if (item.checked) {
                    const nomeMaterial = item.getAttribute('data-nome');
                    const serieInputId = item.getAttribute('data-serie-input');
                    const numeroSerieInput = document.getElementById(serieInputId);
                    const numeroSerie = numeroSerieInput.value.trim();
                    const valueInputId = item.getAttribute('data-value-input');
                    const numeroValueInput = document.getElementById(valueInputId);
                    const numeroValue = parseDecimal(numeroValueInput.value.trim());

                    materiaisSelecionados.push({
                        nome: nomeMaterial + " - Nº de Série: " + numeroSerie + " - Valor: " + numeroValue,
                        numeroSerie: numeroSerie,
                        valor: numeroValue
                    });
                }
            });

            const somaTotal = calcularSomaValoresSelecionados(equipamentosSelecionados, materiaisSelecionados);

            const valorTotalInput = document.getElementById('valorTotal');
            if (valorTotalInput) {
                valorTotalInput.value = somaTotal;
            }

            let contador = 1;

            return {
                somaTotal: somaTotal,
                equipamentosSelecionados: equipamentosSelecionados,
                materiaisSelecionados: materiaisSelecionados,
                contador: contador
            };
        }

        function atualizarDadosFaturamento(faturamentoId, somaTotal, equipamentosSelecionados, materiaisSelecionados, contador) {

            const body = {
                valorTotal: somaTotal,
                novoEquipamentos: equipamentosSelecionados,
                novoMateriais: materiaisSelecionados,
                contador: contador,
            };

            fetch(`https://api.itmf.app.br/faturamento/atualizarFaturamento/atualizar/${faturamentoId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(body),
            })
                .then(response => response.json())
                .then(updatedFaturamento => {
                    console.log(updatedFaturamento);
                    alert('Detalhes do faturamento atualizados com sucesso.');
                    renderNovosEquipamentos(equipamentosSelecionados);
                    renderNovosMateriais(materiaisSelecionados);
                })
                .catch(error => {
                    console.error('Erro ao atualizar detalhes do faturamento:', error);
                });
        }

        const btnAtualizar = document.getElementById('btnAtualizar');
        btnAtualizar.addEventListener('click', function () {
            const faturamentoId = getFaturamentoIdFromUrl();
            updateFaturamento(faturamentoId);
        });

        document.addEventListener('DOMContentLoaded', fetchFaturamentoDetails);

        document.addEventListener('DOMContentLoaded', function () {
            const btnAtualizarEquipamentos = document.getElementById('btnAtualizarEquipamentosMateriais');
            const btnAtualizar = document.getElementById('btnAtualizar');

            fetchFaturamentoDetails();

            function fetchFaturamentoDetails() {
                const faturamentoId = getFaturamentoIdFromUrl();

                if (!faturamentoId) {
                    console.error('ID do faturamento não encontrado na URL.');
                    alert('ID do faturamento não encontrado na URL.');
                    return;
                }

                fetch(`https://api.itmf.app.br/faturamento/receberFaturamento/${faturamentoId}`)
                    .then(response => response.json())
                    .then(faturamento => {

                        fillFaturamentoDetails(faturamento);

                        const contador = faturamento.contador || 0;

                        if (contador === 0) {
                            btnAtualizarEquipamentos.style.display = 'block';
                            btnAtualizar.style.display = 'none';
                        } else {
                            btnAtualizarEquipamentos.style.display = 'none';
                            btnAtualizar.style.display = 'block';
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao obter detalhes do faturamento:', error);
                    });
            }
        });
    </script>
</body>

</html>